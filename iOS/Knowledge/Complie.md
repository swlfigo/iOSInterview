# iOS 编译过程梳理



编译语言在执行的时候，必须先通过编译器生成机器码，机器码可以直接在 CPU 上执行，所以执行效率很高。

## 编译器的概述

编译器的作用是把我们的高级语言转换成机器可以识别的机器码，经典的设计结构如下：

![](http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2021-04-12-072251.jpg)



- 前端（Frontend）：语法分析，语义分析和生成中间代码。在这个过程中，也会对代码进行检查，如果发现出错的或需要警告的会标注出来。
- 优化器（Optimizer）：会进行 BitCode 的生成，链接期优化等工作。
- 后端（Backend）：针对不同的架构，生成对应的机器码。

## Clang + LLVM 的编译过程

1. **预处理阶段**：import 头文件替换；macro 宏展开；处理预编译指令
2. **词法分析**：预处理完成后进入词法分析，将输入的代码转化为一系列符合特定语言的词法单元（token 流）。
3. **语法分析**：将词法分析得到的 token 流进行语法静态分析（Static Analysis），输出**抽象语法树（AST）**，过程中会校验语法是否错误。
4. **CodeGen 生成 IR 中间代码**：CodeGen 负责将语法树自顶向下遍历翻译成 `LLVM IR`，`IR` 是编译过程中前端的输出后端的输入。
5. **Optimize 优化 IR**：到这里 LLVM 会做一些优化工作，在 Xcode 的编译设置里可以设置优化级别 -01, -03, -0s，也可以写自己的 Pass，Pass 是 LLVM 优化工作的一个节点，一个节点做些事，一起加起来就构成了 LLVM 完整的优化和转化。附件：[官方 Pass 教程](http://llvm.org/docs/WritingAnLLVMPass.html)。
6. **LLVM Bitcode 生成字节码**：如果开启了 bitcode，苹果会做进一步优化。若有新的后端架构，依旧可以用这份优化过的 bitcode 去生成。
7. **生成汇编**
8. **生成目标文件**
9. **生成可执行文件**





https://blog.jonyfang.com/2019/09/14/2019-09-14-ios-analyse-llvm/