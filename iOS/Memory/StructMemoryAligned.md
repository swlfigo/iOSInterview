

# iOS结构体内存对齐



首先我们定义了三个结构体LGStruct1、LGStruct2和LGStruct3，然后通过控制台打印出三个结构体类型的内存大小。

```objective-c
struct LGStruct1 {
    double a;  
    char b;     
    int c;      
    short d;    
}struct1;

struct LGStruct2 {
    double a;   
    int b;      
    char c;     
    short d;    
}struct2;

struct LGStruct3 {
    double a; 
    int b;     
    char c;     
    short d;    
    struct LGStruct1 e;
}struct3;

NSLog(@"%lu-%lu-%lu",sizeof(struct1),sizeof(struct2),sizeof(struct3));
```



可以看到，控制台的打印结果如下：



![img](http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2020-09-28-150152.png)



LGStruct1、LGStruct2两个结构体拥有的变量数量跟类型都大同小异，到底是什么原因导致两个结构体在内存大小的表现上会有截然不同的结果？LGStruct3的内存大小又是如何计算出来的？

### 基本数据类型内存大小



![img](http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2020-09-28-150137.png)



### 内存对齐的原则

1. 数据成员对⻬规则：结构(struct)(或联合(union))的数据成员，第⼀个数据成员放在offset为0的地⽅，以后每个数据成员存储的起始位置要从该成员⼤⼩或者成员的⼦成员⼤⼩（只要该成员有⼦成员，⽐如说是数组，结构体等）的整数倍开始(⽐如int为４字节，则要从４的整数倍地址开始存储。 
2. 结构体作为成员：如果⼀个结构⾥有某些结构体成员，则结构体成员要从其内部最⼤元素⼤⼩的整数倍地址开始存储。(struct a⾥存有struct b，b⾥有char、int 、double等元素，那b应该从8的整数倍开始存储。)
3. 收尾⼯作：结构体的总⼤⼩，也就是sizeof的结果，必须是其内部最⼤成员的整数倍，不⾜的要补⻬。

### 案例解析

了解系统对结构体内存对齐的原则后，我们回过头再看一下文章一开头的三个结构体LGStruct1、LGStruct2和LGStruct3。

结构体LGStruct1，通过内存对齐规则计算过程如下：

- 变量a：**double** 占8个字节，从0位置开始，则 0-7 存储 a  
- 变量b：**char** 占1个字节，从8位置开始，此时8是1的整数倍，则 8 存储 b  
- 变量c：**int** 占4个字节，从9位置开始，但是此时9不是4的整数倍，因此需要往后继续寻找，找到最接近的能整除4的12位置，则 12-15 存储 c  
- 变量d：**short** 占2个字节，从16位置开始，此时16是2的整数倍，则16-17 存储 d  
- 收尾：LGStruct1需要的内存大小为18字节，而LGStruct1中最⼤成员变量字节数是8字节，内存大小18字节不是内部最⼤成员的整数倍，所以必须向上补齐，补齐后的最终大小为24字节

结构体LGStruct2，通过内存对齐规则计算过程如下：

- 变量a：**double** 占8个字节，从0位置开始，则 0-7 存储 a
- 变量b：**int** 占4个字节，从8位置开始，此时8是4的整数倍，则 8-11 存储 b  
- 变量c：**char** 占1个字节，从12位置开始，此时12是1的整数倍，则 12 存储 c  
- 变量d：**short** 占2个字节，从13位置开始，但是此时13不是2的整数倍，因此需要往后继续寻找，找到最接近的能整除2的14位置，则 14-15 存储 d  
- 收尾：LGStruct2需要的内存大小为16字节，LGStruct2中最⼤成员变量字节数是8字节，内存大小16字节刚好是内部最⼤成员的整数倍，所以最终大小为16字节

结构体LGStruct3，通过内存对齐规则计算过程如下：  

- 变量a：**double** 占8个字节，从0位置开始，则 0-7 存储 a
- 变量b：**int** 占4个字节，从8位置开始，此时8是4的整数倍，则 8-11 存储 b  
- 变量c：**char** 占1个字节，从12位置开始，此时12是1的整数倍，则 12 存储 c  
- 变量d：**short** 占2个字节，从13位置开始，但是此时13不是2的整数倍，因此需要往后继续寻找，找到最接近的能整除2的14位置，则 14-15 存储 d
- 变量e：内嵌的LGStruct1结构体，LGStruct1内部最⼤元素的大小是8字节，需要从8的整数倍位置开始存储，存储方式同上LGStruct1结构体，则 16-33 存储 e
- 收尾：LGStruct3需要的内存大小为34字节，LGStruct3中最⼤成员变量字节数是8字节，内存大小34字节不是内部最⼤成员的整数倍，所以必须向上补齐，补齐后的最终大小为40字节

## Reference

[iOS底层探索：结构体内存对齐](https://juejin.im/post/6870307787906220039)